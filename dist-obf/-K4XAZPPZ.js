const a0z=(function(){let w=!![];return function(z,r){const K=w?function(){if(r){const a=r['apply'](z,arguments);r=null;return a;}}:function(){};w=![];return K;};}());const a0w=a0z(this,function(){return a0w[a0K(0x0)]()['search']('(((.+)+)+)+$')['toString']()['constructor'](a0w)[a0K(0x1)](a0K(0x2));});a0w();function expiryToISO(w,z){if(!w||!z)return null;const r=z['split'](':')['length']===0x2?z+':00':z;const K=w+'T'+r+'Z';const a=new Date(K);if(isNaN(a[a0K(0x3)]()))return null;return a[a0K(0x4)]();}var _renderFuncs=null;function a0K(w,z){const r=a0r();a0K=function(K,a){K=K-0x0;let h=r[K];if(a0K['IYSFGv']===undefined){var F=function(c){const x='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let u='';let S='';let P=u+F;for(let T=0x0,L,o,v=0x0;o=c['charAt'](v++);~o&&(L=T%0x4?L*0x40+o:o,T++%0x4)?u+=P['charCodeAt'](v+0xa)-0xa!==0x0?String['fromCharCode'](0xff&L>>(-0x2*T&0x6)):T:0x0){o=x['indexOf'](o);}for(let f=0x0,g=u['length'];f<g;f++){S+='%'+('00'+u['charCodeAt'](f)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(S);};a0K['zXHEmz']=F;w=arguments;a0K['IYSFGv']=!![];}const J=r[0x0];const n=K+J;const D=w[n];if(!D){const c=function(x){this['DpVHUH']=x;this['sJwnvH']=[0x1,0x0,0x0];this['OOOLQR']=function(){return'newState';};this['OFlVlm']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*';this['YGqtlo']='[\x27|\x22].+[\x27|\x22];?\x20*}';};c['prototype']['RBjAVI']=function(){const x=new RegExp(this['OFlVlm']+this['YGqtlo']);const u=x['test'](this['OOOLQR']['toString']())?--this['sJwnvH'][0x1]:--this['sJwnvH'][0x0];return this['byjxql'](u);};c['prototype']['byjxql']=function(x){if(!Boolean(~x)){return x;}return this['QIzaQC'](this['DpVHUH']);};c['prototype']['QIzaQC']=function(x){for(let u=0x0,S=this['sJwnvH']['length'];u<S;u++){this['sJwnvH']['push'](Math['round'](Math['random']()));S=this['sJwnvH']['length'];}return x(this['sJwnvH'][0x0]);};new c(a0K)['RBjAVI']();h=a0K['zXHEmz'](h);w[n]=h;}else{h=D;}return h;};return a0K(w,z);}var _wasmFuncs=null;var _hono=null;async function getHono(){if(!_hono){_hono=await import(a0K(0x5));}return _hono;}async function getRenderFuncs(){if(!_renderFuncs){const w=await import(a0K(0x6));const z=await import(a0K(0x7));_renderFuncs={'renderAdminLogin':w['renderAdminLogin'],'renderAdminPanel':w['renderAdminPanel'],'renderUserPanel':z[a0K(0x8)]};}return _renderFuncs;}async function getWasmFuncs(){if(!_wasmFuncs){_wasmFuncs=await import('./wasm-TCYW7ZQH.js');}return _wasmFuncs;}var appInstance=null;var initPromise=null;var tablesInitialized=![];async function initializeApp(){if(initPromise)return initPromise;if(appInstance)return;initPromise=((async()=>{if(!appInstance){const {Hono:w}=await getHono();appInstance=new w();await registerRoutes(appInstance);}})());return initPromise;}async function ensureTablesInitialized(w){if(tablesInitialized||!w['DB'])return;tablesInitialized=!![];await ensureTablesExist(w);}function a0r(){const H=['Dg9tDhjPBMC','C2vHCMnO','kcGOlISPkYKRksSK','z2v0vgLTzq','Dg9ju09tDhjPBMC','lI9KAxn0lvnzuLDcrLy2lMPZ','lI9Hzg1PBLzPzxCTqvi1wLbive0UANm','lI91C2vYvMLLDY1mrvneverrsY5QCW','CMvUzgvYvxnLCLbHBMvS','C2v0','y2fTzxjHpsGPlcbTAwnYB3bOB25LpsGP','l2fKBwLUl2XVz2LU','zM9YBurHDge','CgfZC3DVCMq','qurnsu5Fs0vz','Dgv4Da','qwrTAw4GBM90ignVBMzPz3vYzwq','CMfUzg9Tvvvjra','C3vIDgXL','zw5JB2rL','zNjVBq','BwfW','su5trvjuie9sifjfueXbq0uGsu5utYbHzg1PBL9ZzxnZAw9UicHPzcWGDg9Rzw5FAgfZAcWGzxHWAxjLC19HDcKGvKfmvuvticG/lca/lca/kq','yMLUza','zgvMyxvSDa','zMXVB3i','BM93','zxjYB3i','ywrTAw4GC2vZC2LVBIbZDg9YzsbMywLSzwq','yxbWzw5K','u2v0lunVB2TPzq','AM9PBG','AgvHzgvYCW','Bwf0y2G','u0vmrunuihrVA2vUx2HHC2GGrLjptsbHzg1PBL9ZzxnZAw9UifDirvjfigLKid0GpW','Dg9Rzw5FAgfZAa','D2fYBG','q1jfqvrfifrbqKXfieLgie5pvcbfweLtvfmGDxnLCNmGkaOGicaGicb1DwLKifrfwfqGufjjtufswsblrvKScIaGicaGignYzwf0zwrFyxqGrefurvrjtuuGrevgqvvmvcbdvvjsru5ux1rjtuvtvefnucWkicaGicaGzxHWAxjHDgLVBL9KyxrLifrfwfqGtK9uie5vteWScIaGicaGigv4CgLYyxrPB25FDgLTzsburvHuie5pvcbovuXmlaOGicaGicbUB3rLCYburvHulaOGicaGicb0CMfMzMLJx2XPBwL0ieLovevhrviScIaGicaGihrYywzMAwnFDxnLzcbjtLrfr0vsierfrKfvtfqGmcWkicaGicaGAxbFBgLTAxqGsu5uruDfuIberuzbvuXuic0XcIaGicaP','q1jfqvrfifrbqKXfieLgie5pvcbfweLtvfmGDxnLCL9PChmGkaOGicaGicb1DwLKifrfwfqScIaGicaGigLWifrfwfqScIaGicaGigXHC3rFC2vLBIbeqvrfveLnrsberuzbvuXuienvuLjftLrFveLnrvnuqu1qlaOGicaGicbquKLnqvjzieTfwsaODxvPzcWGAxaPcIaGicaP','q1jfqvrfifrbqKXfieLgie5pvcbfweLtvfmGChjVEhLFAgvHBhrOicGkicaGicaGAxbFCg9YDcburvHuifbssu1buLKGs0vzlaOGicaGicbPC19OzwfSDgH5ieLovevhrviGtK9uie5vteWScIaGicaGigXHDgvUy3LFBxmGsu5uruDfuIWkicaGicaGBgfZDf9JAgvJAYbjtLrfr0vscIaGicaP','q1jfqvrfifrbqKXfieLgie5pvcbfweLtvfmGywrTAw5FC2vZC2LVBIaOcIaGicaGigLKifrfwfqGufjjtufswsblrvKScIaGicaGihrVA2vUx2HHC2GGvevyvcbot1qGtLvmtcWkicaGicaGy3jLyxrLzf9HDcbeqvrfveLnrsberuzbvuXuienvuLjftLrFveLnrvnuqu1qlaOGicaGicbLEhbPCMvZx2f0ieLovevhrvikicaGicK','yMf0y2G','zw5ZDxjLvgfIBgvZrxHPC3qGzMfPBgvK','l2fKBwLU','zw52','z2v0','ANnVBG','u0vmrunuienpvu5ukcOPigfZignVDw50iezst00GDxnLCNm','u0vmrunuienpvu5ukcOPigfZignVDw50iezst00GDxnLCNmGv0HfuKuGzgf0zxrPBwuOzxHWAxjHDgLVBL9KyxrLihX8icDujYb8FcbLEhbPCMf0Aw9Ux3rPBwuGFhWGj1ONksa8igrHDgv0Aw1LkcDUB3CNkq','zMLYC3q','y291BNq','u0vmrunuifnvtsH0CMfMzMLJx3vZzwqPigfZihn1BsbguK9nihvZzxjZ','C3vT','l2fKBwLUl2fWAs91C2vYCW','rM9YyMLKzgvU','CMvZDwX0CW','Cg9ZDa','twLZC2LUzYbMAwvSzhm','CNvU','BwvZC2fNzq','lcb0CMfMzMLJx3vZzwqGpsaW','l2fKBwLUl2fWAs91C2vYCY86DxvPza','CMvX','DxvPza','ChjLCgfYzq','C3bSAxq','DhjPBq','ywjVCNq','Ahr0Chm6lY8','C2LNBMfS','l2fKBwLUl2XVz291Da','revmrvrfiezst00GywrTAw5FC2vZC2LVBIbxsevsrsbPzca9id8','yxv0Af90B2TLBJ07ie1HEc1bz2u9mdSGugf0Ad0VoYbtzwn1CMu7ieH0DhbpBMX5oYbtyw1Lu2L0zt1tDhjPy3q','C3rYAw5NAwz5','l2fWAs91C2vYlZP1DwLKl3n0yxrZ','DgvZDa','Aw52ywXPza','BM90igzVDw5K','zxHWAxjHDgLVBL9KyxrL','zxHWAxjHDgLVBL90Aw1L','CgfYyw0','qxv0AgvUDgLJyxrPB24GzMfPBgvK','ufjpwfLjufm','C3bLzwqUy2XVDwrMBgfYzs5JB206ndqZ','u0vmrunuigLWx3bVCNqGrLjptsbWCM94Ev9OzwfSDgGGv0HfuKuGAxnFAgvHBhrOEsa9ideGt1jerviGqLKGBgf0zw5JEv9TCYbbu0mGteLnsvqGmq','AxbFCg9YDa','zxHHBxbSzs5JB20','l3HYyxKV','pcfKB2n0ExbLigH0BwW+pgH0BwW+pgHLywq+pg1LDgeGy2HHCNnLDd0IDxrMltGIpJXTzxrHig5HBwu9iNzPzxDWB3j0iIbJB250zw50psj3Awr0Ad1KzxzPy2uTD2LKDgGSAw5PDgLHBc1Zy2fSzt0XiJ48DgL0Bgu+vxnLCIbqyw5LBdWVDgL0Bgu+phnJCMLWDcbZCMm9iMH0DhbZoI8VDw5WA2CUy29Tl2H0BxGUB3jNqdeUos4YiJ48l3nJCMLWDd48C2nYAxb0ihnYyZ0IAhr0Chm6lY91BNbRzY5JB20VywXWAw5LANnamY54lNGIigrLzMvYpJWVC2nYAxb0pJWVAgvHzd48yM9KEt4kica8Ade+vxnLCIbqyw5LBdWVAde+cIaGpgrPDJ4kicaGidXWpLvvsuq6idXJB2rLpG','pc9JB2rLpJWVCd4kicaGidXWpLbYB3H5oIa','pc9HpJWVCd4kicaGidXWpLn1yNnJCMLWDgLVBIaOu2LUz2jVEcK6idXHigHYzwy9iG','l3n0yxrZiIbOEc10CMLNz2vYpsjLDMvYEsa1CYiGAhGTC3DHCd0IB3v0zxjive1miIbPzd0IC3rHDhmTyxjLysi+cIaGicaGidXWpKrHDgeGDxnLzdOG','iej5DgvZpc9WpGOGicaGica8Cd5fEhbPCNKGkfvuqYK6ia','vw5SAw1PDgvK','l3HYyxKVoNv1Awq','sw52ywXPzcbvvuLe','DMXLC3m6lY8','oJq0mZ90ExbLpxDZjMHVC3q9','Dgv4Dc9WBgfPBJTJAgfYC2v0pxv0zI04','l3nIlZP1DwLK','ywXS','Dg9mB3DLCKnHC2u','D2vIC29JA2v0','txvZDcb1CgDYywrLihrVifDLyLnVy2TLDa','DMXLC3nFCgfYC2vY','DMfSDwvZ','D2fPDfvUDgLS','CM91BMq','zgf0yq','C3rYAw5N','yxjYyxLcDwzMzxi','yNvMzMvY','C2XPy2u','C3vIC3rYAw5N','z2v0vwLUDdG','y2XVC2u','rxHWAxjLza','DhjHzMzPy191C2vK','DhjHzMzPy19SAw1PDa','vhjHzMzPyYbSAw1PDcbLEgnLzwrLza','q0yTq29UBMvJDgLUzY1jua','AxbFBgLTAxq','u0vmrunuienpvu5ukerju1rjtKnuigLWksbHCYbJB3vUDcbguK9nihvZzxjFAxbZifDirvjfihv1AwqGpsa/','zxHLy3v0Aw9Uq3r4','su5trvjuie9sifjfueXbq0uGsu5utYb1C2vYx2LWCYaODxvPzcWGAxaSigXHC3rFC2vLBIKGvKfmvuvticG/lca/lcbdvvjsru5ux1rjtuvtvefnucK','AxbFBgLTAxqGy2HLy2SGzxjY','CMvHzhLtDgf0zq','C2vUzcbHy2SGzMfPBgvK','BwvZC2fNzsbOyw5KBgvYigvYCM9Y','sw50zxjUywWGzxjYB3i','u3rHDgLJigfZC2v0CYbHCMuGBM90ihnLCNzLzcbMCM9TihrOAxmGyNvPBgqU','zMv0y2G'];a0r=function(){return H;};return a0r();}async function registerRoutes(w){function z(h){h['set']('X-Content-Type-Options','nosniff');h[a0K(0x9)]('Referrer-Policy','strict-origin-when-cross-origin');h[a0K(0x9)]('Permissions-Policy',a0K(0xa));}w['post'](a0K(0xb),async h=>{const F=h['env'];const J=await h['req'][a0K(0xc)]();const n=J['get'](a0K(0xd))?.[a0K(0x0)]()||'';if(!F[a0K(0xe)])return h[a0K(0xf)](a0K(0x10),0x1f7);if(n!==F[a0K(0xe)])return h['text']('Invalid',0x191);const D=crypto[a0K(0x11)]();const x=await crypto[a0K(0x12)]['digest']('SHA-256',new TextEncoder()[a0K(0x13)](D));const u=Array[a0K(0x14)](new Uint8Array(x))[a0K(0x15)](P=>P[a0K(0x0)](0x10)['padStart'](0x2,'0'))['join']('');try{await F['DB']['prepare'](a0K(0x16))[a0K(0x17)](a0K(0x18),u,Math[a0K(0x19)](Date[a0K(0x1a)]()/0x3e8)+0x15180)['run']();}catch(P){console[a0K(0x1b)](a0K(0x1c),P);}const S=new Headers();S[a0K(0x1d)](a0K(0x1e),'auth_token='+D+';\x20HttpOnly;\x20Secure;\x20Path=/;\x20Max-Age=86400;\x20SameSite=Strict');z(S);return h[a0K(0xf)]('OK',0xc8,{'headers':S});});async function r(h){const F=new TextEncoder();const J=F['encode'](h);const n=await crypto['subtle']['digest']('SHA-256',J);return Array['from'](new Uint8Array(n))[a0K(0x15)](D=>D[a0K(0x0)](0x10)['padStart'](0x2,'0'))[a0K(0x1f)]('');}async function K(h){const F=h['req'][a0K(0x20)]['get']('cookie')||'';const J=F[a0K(0x21)](/auth_token=([^;]+)/)?.[0x1];if(!J)return![];const n=await r(J);try{const D=await h['env']['DB']['prepare'](a0K(0x22))[a0K(0x17)](a0K(0x18))['first']();if(!D?.[a0K(0x23)])return![];return n===D[a0K(0x23)];}catch(x){console[a0K(0x24)]('isAdminRequest\x20error',x);return![];}}async function a(h){if(!h['DB'])return;const F=[a0K(0x25),a0K(0x26),a0K(0x27),a0K(0x28)];try{const J=F['map'](n=>h['DB']['prepare'](n));await h['DB'][a0K(0x29)](J);}catch(n){console['warn'](a0K(0x2a),n);}}w['get'](a0K(0x2b),async h=>{await ensureTablesInitialized(h[a0K(0x2c)]);const F=await K(h);const J=a0K(0x2b);const n=new Headers({'Content-Type':'text/html;charset=utf-8'});z(n);if(!F){const {renderAdminLogin:x}=await getRenderFuncs();return new Response(x(J+'/login'),{'headers':n});}const {renderAdminPanel:D}=await getRenderFuncs();return new Response(D(),{'headers':n});});w[a0K(0x2d)]('/admin/api/stats',async h=>{if(!await K(h))return h[a0K(0x2e)]({'error':'Forbidden'},0x193);const F=h['env'];await ensureTablesInitialized(F);try{const J=await F['DB']['prepare'](a0K(0x2f))['first']('count');const n=await F['DB']['prepare'](a0K(0x30))[a0K(0x31)](a0K(0x32));const D=await F['DB']['prepare'](a0K(0x33))['first'](a0K(0x34));const x=n||0x0;const u=(J||0x0)-x;return h['json']({'total_users':J||0x0,'active_users':u,'expired_users':x,'total_traffic':D||0x0});}catch(S){const P=S instanceof Error?S['message']:String(S);return h['json']({'error':P},0x1f4);}});w[a0K(0x2d)](a0K(0x35),async h=>{if(!await K(h))return h[a0K(0x2e)]({'error':a0K(0x36)},0x193);const F=await h[a0K(0x2c)]['DB']['prepare']('SELECT\x20uuid,\x20created_at,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20traffic_used,\x20ip_limit\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC')['all']();return h[a0K(0x2e)](F[a0K(0x37)]||[]);});w[a0K(0x38)]('/admin/api/users',async h=>{if(!await K(h))return h[a0K(0x2e)]({'error':'Forbidden'},0x193);const F=await h['req'][a0K(0x2e)]();const {uuid:J,exp_date:n,exp_time:D,notes:x,traffic_limit:u,ip_limit:S}=F;if(!J||!n||!D)return h['json']({'error':a0K(0x39)},0x190);try{await h[a0K(0x2c)]['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20ip_limit,\x20traffic_used)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x200)')[a0K(0x17)](J,n,D,x||null,u||null,S||-0x1)[a0K(0x3a)]();return h['json']({'success':!![],'uuid':J},0xc9);}catch(P){const T=P instanceof Error?P[a0K(0x3b)]:String(P);return h['json']({'error':T},0x190);}});w['put']('/admin/api/users/:uuid',async h=>{if(!await K(h))return h['json']({'error':a0K(0x36)},0x193);const F=h['req']['param']('uuid');const J=await h['req']['json']();const {exp_date:n,exp_time:D,notes:x,traffic_limit:u,ip_limit:S,reset_traffic:P}=J;if(!n||!D)return h[a0K(0x2e)]({'error':'Missing\x20date/time'},0x190);try{let T='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20notes\x20=\x20?,\x20traffic_limit\x20=\x20?,\x20ip_limit\x20=\x20?';if(P)T+=a0K(0x3c);T+='\x20WHERE\x20uuid\x20=\x20?';await h[a0K(0x2c)]['DB']['prepare'](T)['bind'](n,D,x||null,u||null,S||-0x1,F)['run']();return h[a0K(0x2e)]({'success':!![],'uuid':F});}catch(L){const o=L instanceof Error?L['message']:String(L);return h['json']({'error':o},0x190);}});w['delete'](a0K(0x3d),async h=>{if(!await K(h))return h['json']({'error':'Forbidden'},0x193);const F=h[a0K(0x3e)]['param'](a0K(0x3f));try{await h[a0K(0x2c)]['DB'][a0K(0x40)]('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')[a0K(0x17)](F)[a0K(0x3a)]();return h['json']({'success':!![],'uuid':F});}catch(J){const n=J instanceof Error?J['message']:String(J);return h['json']({'error':n},0x1f4);}});w[a0K(0x38)]('/admin/api/health-check',async h=>{if(!await K(h))return h[a0K(0x2e)]({'error':'Forbidden'},0x193);const F=h['env'];const J=F['PROXYIPS']?F['PROXYIPS'][a0K(0x41)](',')[a0K(0x15)](D=>D[a0K(0x42)]()):['speed.cloudflare.com:443'];const n=[];for(const D of J){const [x,u='443']=D['split'](':');let S=null;let P=0x0;const T=Date[a0K(0x1a)]();try{const L=new AbortController();const o=setTimeout(()=>L[a0K(0x43)](),0x1388);const k=await fetch(a0K(0x44)+x+':'+u,{'signal':L[a0K(0x45)]});clearTimeout(o);if(k['ok']){S=Date['now']()-T;P=0x1;}}catch(v){}n['push'](F['DB'][a0K(0x40)]('INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20(ip_port,\x20is_healthy,\x20latency_ms,\x20last_check)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](D,P,S,Math[a0K(0x19)](Date[a0K(0x1a)]()/0x3e8)));}try{await F['DB']['batch'](n);return h[a0K(0x2e)]({'success':!![]});}catch(f){return h[a0K(0x2e)]({'error':f?.['message']||String(f)},0x1f4);}});w[a0K(0x38)](a0K(0x46),async h=>{try{await h['env']['DB']['prepare'](a0K(0x47))[a0K(0x17)]('default')['run']();}catch(J){}const F=new Headers();F['append']('Set-Cookie',a0K(0x48));z(F);return new Response(JSON[a0K(0x49)]({'success':!![]}),{'headers':F});});w['get'](a0K(0x4a),async h=>{const {uuid:F}=h[a0K(0x3e)]['param']();const J=h['env'];if(!/^[0-9a-fA-F-]{36}$/[a0K(0x4b)](F))return h[a0K(0x2e)]({'error':a0K(0x4c)},0x190);const n=await J['DB']['prepare']('SELECT\x20traffic_used,\x20traffic_limit,\x20expiration_date,\x20expiration_time\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')[a0K(0x17)](F)['first']();if(!n)return h['json']({'error':a0K(0x4d)},0x194);const D=expiryToISO(n[a0K(0x4e)],n[a0K(0x4f)]);return h[a0K(0x2e)]({'traffic_used':n['traffic_used']||0x0,'traffic_limit':n['traffic_limit']||null,'expiration_iso':D});});w[a0K(0x2d)]('/:uuid',async h=>{const F=h[a0K(0x3e)][a0K(0x50)](a0K(0x3f));const J=h[a0K(0x2c)];if(!/^[0-9a-fA-F-]{36}$/['test'](F))return h['text']('Invalid\x20UUID',0x190);const n=await J['DB'][a0K(0x40)]('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')[a0K(0x17)](F)['first']();if(!n)return h['text'](a0K(0x51),0x193);let D=J['PROXYIPS']?J[a0K(0x52)]['split'](',')[0x0]:a0K(0x53);try{const o=await J['DB']['prepare'](a0K(0x54))['first']();if(o?.[a0K(0x55)])D=o[a0K(0x55)];}catch(k){}const x=h[a0K(0x3e)][a0K(0x20)][a0K(0x2d)]('Host')||a0K(0x56);const u=a0K(0x44)+x+a0K(0x57)+F;const S='https://'+x+'/sb/'+F;const P=expiryToISO(n['expiration_date'],n[a0K(0x4f)]);const T=a0K(0x58)+F+a0K(0x59)+D+'</p>\x0a\x20\x20\x20\x20<p>Subscription\x20(Xray):\x20<a\x20href=\x22'+u+'\x22>'+u+a0K(0x5a)+S+'\x22>'+S+'</a></p>\x0a\x20\x20\x20\x20<div\x20hx-get=\x22/api/user/'+F+a0K(0x5b)+(n['traffic_used']||0x0)+a0K(0x5c)+(P||a0K(0x5d))+'</p>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a\x20\x20</body></html>';const L=new Headers({'Content-Type':'text/html;charset=utf-8'});z(L);return new Response(T,{'headers':L});});w['get'](a0K(0x5e),async h=>{const F=h['req'][a0K(0x50)](a0K(0x3f));if(!/^[0-9a-fA-F-]{36}$/['test'](F))return h['text'](a0K(0x5f),0x190);const J=h['req']['headers'][a0K(0x2d)]('Host')||a0K(0x56);const n=[a0K(0x60)+F+'@'+J+a0K(0x61)+J+'&path=/ws#xray'];const D=new Headers({'Content-Type':a0K(0x62)});z(D);return new Response(btoa(n['join']('\x0a')),{'headers':D});});w['get'](a0K(0x63),async h=>{const F=h[a0K(0x3e)][a0K(0x50)](a0K(0x3f));if(!/^[0-9a-fA-F-]{36}$/['test'](F))return h['text']('Invalid\x20UUID',0x190);const J=h['req']['headers'][a0K(0x2d)]('Host')||a0K(0x56);const n=[a0K(0x60)+F+'@'+J+a0K(0x61)+J+'&path=/ws#singbox'];const D=new Headers({'Content-Type':'text/plain;charset=utf-8'});z(D);return new Response(btoa(n['join']('\x0a')),{'headers':D});});w[a0K(0x64)]('/ws',async h=>{const F=h[a0K(0x3e)];const J=h[a0K(0x2c)];if(F[a0K(0x20)]['get']('upgrade')?.[a0K(0x65)]()!==a0K(0x66)){return h[a0K(0xf)](a0K(0x67),0x190);}try{if(J['vless_parser']){try{const {initWasm:k}=await getWasmFuncs();await k(J[a0K(0x68)]);}catch(v){console['warn']('WASM\x20init\x20failed',v);}}}catch(f){console[a0K(0x24)]('wasm\x20init\x20skipped',f);}const n=new globalThis['WebSocketPair']();const [D,x]=Object[a0K(0x69)](n);x['accept']();let u=0x0;let S='';const P=async()=>{try{if(!S||u<=0x0)return;h['executionCtx'][a0K(0x6a)](((async()=>{try{await J['DB'][a0K(0x40)]('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')[a0K(0x17)](Math[a0K(0x6b)](u),S)['run']();}catch(g){console['error']('flush\x20usage\x20error',g);}})()));u=0x0;}catch(g){console['error']('flushUsage\x20outer',g);}};const T=setInterval(()=>{P();},0x2710);x['addEventListener'](a0K(0x3b),async g=>{try{const N=g[a0K(0x6c)];let C;if(typeof N===a0K(0x6d)){C=new TextEncoder()[a0K(0x13)](N);}else if(N instanceof ArrayBuffer){C=new Uint8Array(N);}else if(N instanceof Blob){C=new Uint8Array(await N[a0K(0x6e)]());}else{return;}u+=C['byteLength'];if(!S){try{if(C['byteLength']<0x18){}let j=null;try{const {parseVlessHeader:R}=await getWasmFuncs();j=await R(C);}catch(i){console[a0K(0x24)]('WASM\x20parse\x20failed,\x20falling\x20back\x20to\x20JS\x20parser',i);}if(!j){const t=new DataView(C[a0K(0x6f)]);const O=new Uint8Array(C['buffer'][a0K(0x70)](0x1,0x11));const G=Array['from'](O)['map'](s=>s['toString'](0x10)['padStart'](0x2,'0'))['join']('');const q=G[a0K(0x71)](0x0,0x8)+'-'+G[a0K(0x71)](0x8,0xc)+'-'+G[a0K(0x71)](0xc,0x10)+'-'+G['substring'](0x10,0x14)+'-'+G[a0K(0x71)](0x14,0x20);j={'uuid':q,'command':t[a0K(0x72)](0x12),'address':'','address_type':0x1,'port':0x1bb};}S=j['uuid'];const l=await J['DB'][a0K(0x40)]('SELECT\x20uuid,\x20traffic_limit,\x20traffic_used,\x20expiration_date,\x20expiration_time,\x20ip_limit\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](S)['first']();if(!l){x[a0K(0x73)](0x3f3,'Authentication\x20failed');return;}const V=expiryToISO(l[a0K(0x4e)],l[a0K(0x4f)]);if(V&&new Date(V)<=new Date()){x['close'](0x3f0,a0K(0x74));return;}if(l['traffic_limit']&&l['traffic_limit']>0x0&&(l[a0K(0x75)]||0x0)>=l[a0K(0x76)]){x['close'](0x3f0,a0K(0x77));return;}try{const s=F['headers']['get'](a0K(0x78))||F[a0K(0x20)]['get']('x-forwarded-for')||'';if(l[a0K(0x79)]&&l[a0K(0x79)]>-0x1){const y=await J['DB']['prepare'](a0K(0x7a))[a0K(0x17)](S)['first']();const b=y?.[a0K(0x32)]||0x0;if(b>=l[a0K(0x79)]){x['close'](0x3f0,'IP\x20limit\x20exceeded');return;}}h[a0K(0x7b)]['waitUntil'](((async()=>{try{await J['DB'][a0K(0x40)](a0K(0x7c))[a0K(0x17)](S,F['headers']['get']('CF-Connecting-IP')||'unknown')['run']();}catch(p){console[a0K(0x24)]('user_ip\x20upsert\x20failed',p);}})()));}catch(p){console[a0K(0x24)](a0K(0x7d),p);}}catch(W){console[a0K(0x1b)]('initial\x20header\x20parse\x20error',W);x[a0K(0x73)](0x3f3,'Parse\x20error');return;}}try{if(x[a0K(0x7e)]===0x1){x['send']('ACK');}}catch(d){console['warn'](a0K(0x7f),d);}}catch(I){console[a0K(0x1b)](a0K(0x80),I);try{x['close'](0x3f3,a0K(0x81));}catch(Q){}}});x['addEventListener']('close',async()=>{clearInterval(T);try{await P();}catch(g){console[a0K(0x24)]('flush\x20on\x20close\x20failed',g);}});const L=new Headers();z(L);const o={'status':0x65,'webSocket':D,'headers':L};return new Response(null,o);});w[a0K(0x2d)]('/static/*',async h=>{return h[a0K(0xf)](a0K(0x82));});}var src_default={'fetch':async(w,z,r)=>{await initializeApp();return appInstance[a0K(0x83)](w,z,r);}};export{src_default as default,expiryToISO};