const a0c=(function(){let b=!![];return function(c,J){const g=b?function(){if(J){const j=J[a0g(0x0)](c,arguments);J=null;return j;}}:function(){};b=![];return g;};}());const a0b=a0c(this,function(){return a0b[a0g(0x1)]()[a0g(0x2)](a0g(0x3))[a0g(0x1)]()['constructor'](a0b)['search'](a0g(0x3));});a0b();function a0J(){const A=['yxbWBhK','Dg9tDhjPBMC','C2vHCMnO','kcGOlISPkYKRksSK','oJaW','lI9KAxn0lvnzuLDcrLy2lMPZ','lI9Hzg1PBLzPzxCTqvi1wLbive0UANm','lI91C2vYvMLLDY1mrvneverrsY5QCW','CMvUzgvYvxnLCLbHBMvS','BM9ZBMLMzG','uMvMzxjYzxiTug9SAwn5','ugvYBwLZC2LVBNmTug9SAwn5','Cg9ZDa','CMvX','zM9YBurHDge','z2v0','Dgv4Da','qurnsu5Fs0vz','zgLNzxn0','zw5JB2rL','zNjVBq','BwfW','CgfKu3rHCNq','AM9PBG','zMXVB3i','BM93','zxjYB3i','u2v0lunVB2TPzq','yxv0Af90B2TLBJ0','u0Hblti1nG','y29VA2LL','ChjLCgfYzq','u0vmrunuihrVA2vUx2HHC2GGrLjptsbHzg1PBL9ZzxnZAw9UifDirvjfigLKid0GpW','Dg9Rzw5FAgfZAa','Axnbzg1PBLjLCxvLC3qGzxjYB3i','q1jfqvrfifrbqKXfieLgie5pvcbfweLtvfmGDxnLCNmGkaOGicaGicb1DwLKifrfwfqGufjjtufswsblrvKScIaGicaGignYzwf0zwrFyxqGrefurvrjtuuGrevgqvvmvcbdvvjsru5ux1rjtuvtvefnucWkicaGicaGzxHWAxjHDgLVBL9KyxrLifrfwfqGtK9uie5vteWScIaGicaGigv4CgLYyxrPB25FDgLTzsburvHuie5pvcbovuXmlaOGicaGicbUB3rLCYburvHulaOGicaGicb0CMfMzMLJx2XPBwL0ieLovevhrviScIaGicaGihrYywzMAwnFDxnLzcbjtLrfr0vsierfrKfvtfqGmcWkicaGicaGAxbFBgLTAxqGsu5uruDfuIberuzbvuXuic0XcIaGicaP','q1jfqvrfifrbqKXfieLgie5pvcbfweLtvfmGDxnLCL9PChmGkaOGicaGicb1DwLKifrfwfqScIaGicaGigLWifrfwfqScIaGicaGigXHC3rFC2vLBIbeqvrfveLnrsberuzbvuXuienvuLjftLrFveLnrvnuqu1qlaOGicaGicbquKLnqvjzieTfwsaODxvPzcWGAxaPcIaGicaP','q1jfqvrfifrbqKXfieLgie5pvcbfweLtvfmGChjVEhLFAgvHBhrOicGkicaGicaGAxbFCg9YDcburvHuifbssu1buLKGs0vzlaOGicaGicbPC19OzwfSDgH5ieLovevhrviGtK9uie5vteWScIaGicaGigXHDgvUy3LFBxmGsu5uruDfuIWkicaGicaGBgfZDf9JAgvJAYbjtLrfr0vscIaGicaP','yMf0y2G','D2fYBG','zw52','l2XVz2LU','u0vmrunuienpvu5ukcOPigfZignVDw50iezst00GDxnLCNm','y291BNq','zMLYC3q','u0vmrunuifnvtsH0CMfMzMLJx3vZzwqPigfZihn1BsbguK9nihvZzxjZ','C3vT','ANnVBG','BwvZC2fNzq','u0vmrunuihv1AwqSignYzwf0zwrFyxqSigv4CgLYyxrPB25Fzgf0zsWGzxHWAxjHDgLVBL90Aw1LlcbUB3rLCYWGDhjHzMzPy19SAw1PDcWGDhjHzMzPy191C2vKlcbPCf9SAw1PDcbguK9nihvZzxjZie9srevsiejzignYzwf0zwrFyxqGrevtqW','l2fKBwLUl2fWAs91C2vYCW','su5trvjuieLove8GDxnLCNmGkhv1AwqSigv4CgLYyxrPB25Fzgf0zsWGzxHWAxjHDgLVBL90Aw1LlcbUB3rLCYWGDhjHzMzPy19SAw1PDcWGAxbFBgLTAxqSihrYywzMAwnFDxnLzcKGvKfmvuvticG/lca/lca/lca/lca/lca/lcaWkq','yMLUza','CNvU','Chv0','l2fKBwLUl2fWAs91C2vYCY86DxvPza','DxvPza','twLZC2LUzYbKyxrLl3rPBwu','CgfYyw0','revmrvrfiezst00GDxnLCNmGv0HfuKuGDxvPzca9id8','l2fKBwLUl2fWAs9OzwfSDgGTy2HLy2S','C3bSAxq','ndqZ','ywjVCNq','su5trvjuie9sifjfueXbq0uGsu5utYbWCM94Ev9OzwfSDgGGkgLWx3bVCNqSigLZx2HLywX0AhKSigXHDgvUy3LFBxmSigXHC3rFy2HLy2SPifzbtfvfuYaOpYWGpYWGpYWGpYK','l2fKBwLUl2XVz291Da','C3rYAw5NAwz5','l2fWAs91C2vYlZP1DwLKl3n0yxrZ','DgvZDa','Aw52ywXPza','u0vmrunuihrYywzMAwnFDxnLzcWGDhjHzMzPy19SAw1PDcWGzxHWAxjHDgLVBL9KyxrLlcbLEhbPCMf0Aw9Ux3rPBwuGrLjptsb1C2vYCYbxsevsrsb1DwLKid0GpW','zxHWAxjHDgLVBL9KyxrL','DhjHzMzPy191C2vK','DhjHzMzPy19SAw1PDa','sw52ywXPzcbvvuLe','ufjpwfLjufm','AxbFCg9YDa','AgvHzgvYCW','Ahr0Chm6lY8','l3HYyxKV','l3nIlW','pc9WpGOGicaGpha+u3vIC2nYAxb0Aw9UicHyCMf5ktOGpgeGAhjLzJ0I','l3n0yxrZiIbOEc10CMLNz2vYpsjLDMvYEsa1CYiGAhGTC3DHCd0IB3v0zxjive1miIbPzd0IC3rHDhmTyxjLysi+cIaGicaGidXWpKrHDgeGDxnLzdOG','iej5DgvZpc9WpGOGicaGica8Cd5fEhbPCNKGkfvuqYK6ia','pc9WpGOGicaGpc9KAxy+cIaGpc9KAxy+cIaGpc9IB2r5pJWVAhrTBd4','Dgv4Dc9ODg1So2nOyxjZzxq9DxrMltG','l3HYyxKVoNv1Awq','sg9ZDa','oJq0mZ90ExbLpxDZjMHVC3q9','jNbHDgG9l3DZi3HYyxK','l3nIlZP1DwLK','DMXLC3m6lY8','jNbHDgG9l3DZi3nPBMDIB3G','Dgv4Dc9WBgfPBJTJAgfYC2v0pxv0zI04','DxbNCMfKzq','Dg9mB3DLCKnHC2u','D2vIC29JA2v0','DMXLC3nFCgfYC2vY','v0fttsbPBML0igzHAwXLza','D2fZBsbPBML0ihnRAxbWzwq','v2vIu29JA2v0ugfPCG','DMfSDwvZ','ywnJzxb0','zxHLy3v0Aw9Uq3r4','D2fPDfvUDgLS','zMX1C2HvC2fNzsbVDxrLCG','C3rYAw5N','yxjYyxLcDwzMzxi','C3vIC3rYAw5N','z2v0vwLUDdG','qxv0AgvUDgLJyxrPB24GzMfPBgvK','zxHWAxjHDgLVBL90Aw1L','rxHWAxjLza','y2XVC2u','q0yTq29UBMvJDgLUzY1jua','Ec1MB3j3yxjKzwqTzM9Y','AxbFBgLTAxq','svaGBgLTAxqGzxHJzwvKzwq','AxbFBgLTAxqGy2HLy2SGzxjY','ugfYC2uGzxjYB3i','CMvHzhLtDgf0zq','qunl','BwvZC2fNzsbOyw5KBgvYigvYCM9Y','sw50zxjUywWGzxjYB3i','l3n0yxrPyY8Q','u3rHDgLJigfZC2v0CYbHCMuGBM90ihnLCNzLzcbMCM9TihrOAxmGyNvPBgqU','zMv0y2G'];a0J=function(){return A;};return a0J();}function expiryToISO(b,c){if(!b||!c)return null;const J=c['split'](':')['length']===0x2?c+a0g(0x4):c;const g=b+'T'+J+'Z';const j=new Date(g);if(isNaN(j['getTime']()))return null;return j['toISOString']();}var _renderFuncs=null;var _wasmFuncs=null;var _hono=null;async function getHono(){if(!_hono){_hono=await import(a0g(0x5));}return _hono;}async function getRenderFuncs(){if(!_renderFuncs){const b=await import(a0g(0x6));const c=await import(a0g(0x7));_renderFuncs={'renderAdminLogin':b['renderAdminLogin'],'renderAdminPanel':b['renderAdminPanel'],'renderUserPanel':c[a0g(0x8)]};}return _renderFuncs;}async function getWasmFuncs(){if(!_wasmFuncs){_wasmFuncs=await import('./wasm-TCYW7ZQH.js');}return _wasmFuncs;}var appInstance=null;var initPromise=null;function a0g(b,c){const J=a0J();a0g=function(g,j){g=g-0x0;let W=J[g];if(a0g['NCOdYK']===undefined){var x=function(f){const D='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let F='';let y='';let K=F+x;for(let z=0x0,I,s,V=0x0;s=f['charAt'](V++);~s&&(I=z%0x4?I*0x40+s:s,z++%0x4)?F+=K['charCodeAt'](V+0xa)-0xa!==0x0?String['fromCharCode'](0xff&I>>(-0x2*z&0x6)):z:0x0){s=D['indexOf'](s);}for(let l=0x0,H=F['length'];l<H;l++){y+='%'+('00'+F['charCodeAt'](l)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(y);};a0g['hUGmyL']=x;b=arguments;a0g['NCOdYK']=!![];}const e=J[0x0];const n=g+e;const r=b[n];if(!r){const f=function(D){this['RSAFQR']=D;this['OrqTIE']=[0x1,0x0,0x0];this['CBjyib']=function(){return'newState';};this['meZMxe']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*';this['zNmYXG']='[\x27|\x22].+[\x27|\x22];?\x20*}';};f['prototype']['oIPlvM']=function(){const D=new RegExp(this['meZMxe']+this['zNmYXG']);const F=D['test'](this['CBjyib']['toString']())?--this['OrqTIE'][0x1]:--this['OrqTIE'][0x0];return this['lQpZhf'](F);};f['prototype']['lQpZhf']=function(D){if(!Boolean(~D)){return D;}return this['mMviMP'](this['RSAFQR']);};f['prototype']['mMviMP']=function(D){for(let F=0x0,y=this['OrqTIE']['length'];F<y;F++){this['OrqTIE']['push'](Math['round'](Math['random']()));y=this['OrqTIE']['length'];}return D(this['OrqTIE'][0x0]);};new f(a0g)['oIPlvM']();W=a0g['hUGmyL'](W);b[n]=W;}else{W=r;}return W;};return a0g(b,c);}var tablesInitialized=![];async function initializeApp(){if(initPromise)return initPromise;if(appInstance)return;initPromise=((async()=>{if(!appInstance){const {Hono:b}=await getHono();appInstance=new b();await registerRoutes(appInstance);}})());return initPromise;}async function ensureTablesInitialized(b){if(tablesInitialized||!b['DB'])return;tablesInitialized=!![];await ensureTablesExist(b);}async function registerRoutes(b){function c(W){W['set']('X-Content-Type-Options',a0g(0x9));W['set'](a0g(0xa),'strict-origin-when-cross-origin');W['set'](a0g(0xb),'camera=(),\x20microphone=()');}b[a0g(0xc)]('/admin/login',async W=>{const x=W['env'];const n=await W[a0g(0xd)][a0g(0xe)]();const r=n[a0g(0xf)]('password')?.[a0g(0x1)]()||'';if(!x['ADMIN_KEY'])return W[a0g(0x10)]('Admin\x20not\x20configured',0x1f7);if(r!==x[a0g(0x11)])return W['text']('Invalid',0x191);const f=crypto['randomUUID']();const D=await crypto['subtle'][a0g(0x12)]('SHA-256',new TextEncoder()[a0g(0x13)](f));const F=Array[a0g(0x14)](new Uint8Array(D))[a0g(0x15)](K=>K[a0g(0x1)](0x10)[a0g(0x16)](0x2,'0'))[a0g(0x17)]('');try{await x['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20admin_session\x20(id,\x20token_hash,\x20expires_at)\x20VALUES\x20(?,\x20?,\x20?)')['bind']('default',F,Math[a0g(0x18)](Date[a0g(0x19)]()/0x3e8)+0x15180)['run']();}catch(K){console[a0g(0x1a)]('admin\x20session\x20store\x20failed',K);}const y=new Headers();y['append'](a0g(0x1b),a0g(0x1c)+f+';\x20HttpOnly;\x20Secure;\x20Path=/;\x20Max-Age=86400;\x20SameSite=Strict');c(y);return W[a0g(0x10)]('OK',0xc8,{'headers':y});});async function J(W){const x=new TextEncoder();const e=x[a0g(0x13)](W);const n=await crypto['subtle']['digest'](a0g(0x1d),e);return Array['from'](new Uint8Array(n))[a0g(0x15)](r=>r[a0g(0x1)](0x10)[a0g(0x16)](0x2,'0'))[a0g(0x17)]('');}async function g(W){const x=W[a0g(0xd)]['headers'][a0g(0xf)](a0g(0x1e))||'';const n=x['match'](/auth_token=([^;]+)/)?.[0x1];if(!n)return![];const r=await J(n);try{const f=await W['env']['DB'][a0g(0x1f)](a0g(0x20))['bind']('default')['first']();if(!f?.['token_hash'])return![];return r===f[a0g(0x21)];}catch(D){console['warn'](a0g(0x22),D);return![];}}async function j(W){if(!W['DB'])return;const x=[a0g(0x23),a0g(0x24),a0g(0x25),'CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20admin_session\x20(\x0a\x20\x20\x20\x20\x20\x20id\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20token_hash\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20created_at\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20expires_at\x20INTEGER\x0a\x20\x20\x20\x20)'];try{const n=x['map'](r=>W['DB']['prepare'](r));await W['DB'][a0g(0x26)](n);}catch(r){console[a0g(0x27)]('ensureTablesExist\x20failed',r);}}b[a0g(0xf)]('/admin',async W=>{await ensureTablesInitialized(W[a0g(0x28)]);const x=await g(W);const e='/admin';const n=new Headers({'Content-Type':'text/html;charset=utf-8'});c(n);if(!x){const {renderAdminLogin:f}=await getRenderFuncs();return new Response(f(e+a0g(0x29)),{'headers':n});}const {renderAdminPanel:r}=await getRenderFuncs();return new Response(r(),{'headers':n});});b[a0g(0xf)]('/admin/api/stats',async W=>{if(!await g(W))return W['json']({'error':'Forbidden'},0x193);const x=W[a0g(0x28)];await ensureTablesInitialized(x);try{const n=await x['DB'][a0g(0x1f)](a0g(0x2a))['first'](a0g(0x2b));const r=await x['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users\x20WHERE\x20datetime(expiration_date\x20||\x20\x27T\x27\x20||\x20expiration_time\x20||\x20\x27Z\x27)\x20<\x20datetime(\x27now\x27)')[a0g(0x2c)]('count');const f=await x['DB'][a0g(0x1f)](a0g(0x2d))[a0g(0x2c)](a0g(0x2e));const D=r||0x0;const F=(n||0x0)-D;return W[a0g(0x2f)]({'total_users':n||0x0,'active_users':F,'expired_users':D,'total_traffic':f||0x0});}catch(y){const K=y instanceof Error?y[a0g(0x30)]:String(y);return W['json']({'error':K},0x1f4);}});b[a0g(0xf)]('/admin/api/users',async W=>{if(!await g(W))return W['json']({'error':'Forbidden'},0x193);const x=await W['env']['DB']['prepare'](a0g(0x31))['all']();return W[a0g(0x2f)](x['results']||[]);});b[a0g(0xc)](a0g(0x32),async W=>{if(!await g(W))return W[a0g(0x2f)]({'error':'Forbidden'},0x193);const x=await W['req'][a0g(0x2f)]();const {uuid:n,exp_date:r,exp_time:f,notes:D,traffic_limit:F,ip_limit:y}=x;if(!n||!r||!f)return W['json']({'error':'Missing\x20fields'},0x190);try{await W[a0g(0x28)]['DB']['prepare'](a0g(0x33))[a0g(0x34)](n,r,f,D||null,F||null,y||-0x1)[a0g(0x35)]();return W['json']({'success':!![],'uuid':n},0xc9);}catch(K){const z=K instanceof Error?K[a0g(0x30)]:String(K);return W['json']({'error':z},0x190);}});b[a0g(0x36)](a0g(0x37),async W=>{if(!await g(W))return W[a0g(0x2f)]({'error':'Forbidden'},0x193);const x=W['req']['param'](a0g(0x38));const n=await W['req'][a0g(0x2f)]();const {exp_date:r,exp_time:f,notes:D,traffic_limit:F,ip_limit:y,reset_traffic:K}=n;if(!r||!f)return W['json']({'error':a0g(0x39)},0x190);try{let z='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20notes\x20=\x20?,\x20traffic_limit\x20=\x20?,\x20ip_limit\x20=\x20?';if(K)z+=',\x20traffic_used\x20=\x200';z+='\x20WHERE\x20uuid\x20=\x20?';await W[a0g(0x28)]['DB'][a0g(0x1f)](z)[a0g(0x34)](r,f,D||null,F||null,y||-0x1,x)[a0g(0x35)]();return W[a0g(0x2f)]({'success':!![],'uuid':x});}catch(I){const s=I instanceof Error?I[a0g(0x30)]:String(I);return W['json']({'error':s},0x190);}});b['delete'](a0g(0x37),async W=>{if(!await g(W))return W['json']({'error':'Forbidden'},0x193);const x=W['req'][a0g(0x3a)]('uuid');try{await W['env']['DB'][a0g(0x1f)](a0g(0x3b))[a0g(0x34)](x)['run']();return W[a0g(0x2f)]({'success':!![],'uuid':x});}catch(n){const r=n instanceof Error?n['message']:String(n);return W['json']({'error':r},0x1f4);}});b[a0g(0xc)](a0g(0x3c),async W=>{if(!await g(W))return W['json']({'error':'Forbidden'},0x193);const x=W['env'];const n=x['PROXYIPS']?x['PROXYIPS'][a0g(0x3d)](',')['map'](D=>D['trim']()):['speed.cloudflare.com:443'];const f=[];for(const D of n){const [F,y=a0g(0x3e)]=D['split'](':');let K=null;let z=0x0;const I=Date['now']();try{const s=new AbortController();const k=setTimeout(()=>s[a0g(0x3f)](),0x1388);const V=await fetch('https://'+F+':'+y,{'signal':s['signal']});clearTimeout(k);if(V['ok']){K=Date[a0g(0x19)]()-I;z=0x1;}}catch(l){}f['push'](x['DB'][a0g(0x1f)](a0g(0x40))[a0g(0x34)](D,z,K,Math['floor'](Date['now']()/0x3e8)));}try{await x['DB']['batch'](f);return W['json']({'success':!![]});}catch(H){return W['json']({'error':H?.['message']||String(H)},0x1f4);}});b[a0g(0xc)](a0g(0x41),async W=>{try{await W['env']['DB']['prepare']('DELETE\x20FROM\x20admin_session\x20WHERE\x20id\x20=\x20?')[a0g(0x34)]('default')[a0g(0x35)]();}catch(n){}const x=new Headers();x['append'](a0g(0x1b),'auth_token=;\x20Max-Age=0;\x20Path=/;\x20Secure;\x20HttpOnly;\x20SameSite=Strict');c(x);return new Response(JSON[a0g(0x42)]({'success':!![]}),{'headers':x});});b['get'](a0g(0x43),async W=>{const {uuid:x}=W['req'][a0g(0x3a)]();const e=W['env'];if(!/^[0-9a-fA-F-]{36}$/[a0g(0x44)](x))return W[a0g(0x2f)]({'error':a0g(0x45)},0x190);const n=await e['DB'][a0g(0x1f)](a0g(0x46))[a0g(0x34)](x)['first']();if(!n)return W['json']({'error':'not\x20found'},0x194);const r=expiryToISO(n[a0g(0x47)],n['expiration_time']);return W['json']({'traffic_used':n[a0g(0x48)]||0x0,'traffic_limit':n[a0g(0x49)]||null,'expiration_iso':r});});b['get']('/:uuid',async W=>{const x=W['req'][a0g(0x3a)]('uuid');const n=W['env'];if(!/^[0-9a-fA-F-]{36}$/[a0g(0x44)](x))return W['text'](a0g(0x4a),0x190);const r=await n['DB'][a0g(0x1f)]('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')[a0g(0x34)](x)['first']();if(!r)return W[a0g(0x10)]('Authentication\x20failed',0x193);let f=n[a0g(0x4b)]?n[a0g(0x4b)]['split'](',')[0x0]:'speed.cloudflare.com:443';try{const s=await n['DB'][a0g(0x1f)]('SELECT\x20ip_port\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x201')[a0g(0x2c)]();if(s?.[a0g(0x4c)])f=s['ip_port'];}catch(k){}const D=W[a0g(0xd)][a0g(0x4d)][a0g(0xf)]('Host')||'example.com';const F=a0g(0x4e)+D+a0g(0x4f)+x;const y='https://'+D+a0g(0x50)+x;const K=expiryToISO(r['expiration_date'],r['expiration_time']);const z='<!doctype\x20html><html><head><meta\x20charset=\x22utf-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22><title>User\x20Panel</title><script\x20src=\x22https://unpkg.com/htmx.org@1.9.2\x22></script><script\x20src=\x22https://unpkg.com/alpinejs@3.x.x\x22\x20defer></script></head><body>\x0a\x20\x20<h1>User\x20Panel</h1>\x0a\x20\x20<div>\x0a\x20\x20\x20\x20<p>UUID:\x20<code>'+x+'</code></p>\x0a\x20\x20\x20\x20<p>Proxy:\x20'+f+a0g(0x51)+F+'\x22>'+F+'</a></p>\x0a\x20\x20\x20\x20<p>Subscription\x20(Singbox):\x20<a\x20href=\x22'+y+'\x22>'+y+'</a></p>\x0a\x20\x20\x20\x20<div\x20hx-get=\x22/api/user/'+x+a0g(0x52)+(r[a0g(0x48)]||0x0)+a0g(0x53)+(K||'Unlimited')+a0g(0x54);const I=new Headers({'Content-Type':a0g(0x55)});c(I);return new Response(z,{'headers':I});});b['get'](a0g(0x56),async W=>{const x=W['req'][a0g(0x3a)](a0g(0x38));if(!/^[0-9a-fA-F-]{36}$/['test'](x))return W[a0g(0x10)](a0g(0x4a),0x190);const e=W[a0g(0xd)][a0g(0x4d)]['get'](a0g(0x57))||'example.com';const n=['vless://'+x+'@'+e+a0g(0x58)+e+a0g(0x59)];const r=new Headers({'Content-Type':'text/plain;charset=utf-8'});c(r);return new Response(btoa(n['join']('\x0a')),{'headers':r});});b['get'](a0g(0x5a),async W=>{const x=W['req'][a0g(0x3a)]('uuid');if(!/^[0-9a-fA-F-]{36}$/['test'](x))return W['text'](a0g(0x4a),0x190);const e=W[a0g(0xd)][a0g(0x4d)]['get']('Host')||'example.com';const n=[a0g(0x5b)+x+'@'+e+a0g(0x58)+e+a0g(0x5c)];const r=new Headers({'Content-Type':a0g(0x5d)});c(r);return new Response(btoa(n[a0g(0x17)]('\x0a')),{'headers':r});});b['all']('/ws',async W=>{const x=W['req'];const n=W['env'];if(x[a0g(0x4d)][a0g(0xf)](a0g(0x5e))?.[a0g(0x5f)]()!==a0g(0x60)){return W[a0g(0x10)]('Must\x20upgrade\x20to\x20WebSocket',0x190);}try{if(n[a0g(0x61)]){try{const {initWasm:k}=await getWasmFuncs();await k(n['vless_parser']);}catch(V){console['warn'](a0g(0x62),V);}}}catch(l){console[a0g(0x27)](a0g(0x63),l);}const r=new globalThis[(a0g(0x64))]();const [f,D]=Object[a0g(0x65)](r);D[a0g(0x66)]();let F=0x0;let y='';const K=async()=>{try{if(!y||F<=0x0)return;W[a0g(0x67)][a0g(0x68)](((async()=>{try{await n['DB'][a0g(0x1f)]('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')[a0g(0x34)](Math['round'](F),y)['run']();}catch(H){console[a0g(0x1a)]('flush\x20usage\x20error',H);}})()));F=0x0;}catch(H){console['error'](a0g(0x69),H);}};const z=setInterval(()=>{K();},0x2710);D['addEventListener']('message',async H=>{try{const G=H['data'];let p;if(typeof G===a0g(0x6a)){p=new TextEncoder()[a0g(0x13)](G);}else if(G instanceof ArrayBuffer){p=new Uint8Array(G);}else if(G instanceof Blob){p=new Uint8Array(await G[a0g(0x6b)]());}else{return;}F+=p['byteLength'];if(!y){try{if(p['byteLength']<0x18){}let u=null;try{const {parseVlessHeader:C}=await getWasmFuncs();u=await C(p);}catch(M){console[a0g(0x27)]('WASM\x20parse\x20failed,\x20falling\x20back\x20to\x20JS\x20parser',M);}if(!u){const q=new DataView(p['buffer']);const X=new Uint8Array(p['buffer']['slice'](0x1,0x11));const B=Array[a0g(0x14)](X)[a0g(0x15)](i=>i[a0g(0x1)](0x10)[a0g(0x16)](0x2,'0'))['join']('');const T=B[a0g(0x6c)](0x0,0x8)+'-'+B[a0g(0x6c)](0x8,0xc)+'-'+B['substring'](0xc,0x10)+'-'+B['substring'](0x10,0x14)+'-'+B[a0g(0x6c)](0x14,0x20);u={'uuid':T,'command':q[a0g(0x6d)](0x12),'address':'','address_type':0x1,'port':0x1bb};}y=u[a0g(0x38)];const O=await n['DB']['prepare']('SELECT\x20uuid,\x20traffic_limit,\x20traffic_used,\x20expiration_date,\x20expiration_time,\x20ip_limit\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')[a0g(0x34)](y)['first']();if(!O){D['close'](0x3f3,a0g(0x6e));return;}const N=expiryToISO(O['expiration_date'],O[a0g(0x6f)]);if(N&&new Date(N)<=new Date()){D['close'](0x3f0,a0g(0x70));return;}if(O['traffic_limit']&&O[a0g(0x49)]>0x0&&(O['traffic_used']||0x0)>=O['traffic_limit']){D[a0g(0x71)](0x3f0,'Traffic\x20limit\x20exceeded');return;}try{const i=x[a0g(0x4d)]['get'](a0g(0x72))||x['headers']['get'](a0g(0x73))||'';if(O[a0g(0x74)]&&O[a0g(0x74)]>-0x1){const Y=await n['DB'][a0g(0x1f)]('SELECT\x20COUNT(DISTINCT\x20ip)\x20as\x20count\x20FROM\x20user_ips\x20WHERE\x20uuid\x20=\x20?')['bind'](y)[a0g(0x2c)]();const S=Y?.[a0g(0x2b)]||0x0;if(S>=O[a0g(0x74)]){D[a0g(0x71)](0x3f0,a0g(0x75));return;}}W[a0g(0x67)]['waitUntil'](((async()=>{try{await n['DB'][a0g(0x1f)]('INSERT\x20OR\x20REPLACE\x20INTO\x20user_ips\x20(uuid,\x20ip,\x20last_seen)\x20VALUES\x20(?,\x20?,\x20CURRENT_TIMESTAMP)')[a0g(0x34)](y,x['headers']['get'](a0g(0x72))||'unknown')['run']();}catch(a){console[a0g(0x27)]('user_ip\x20upsert\x20failed',a);}})()));}catch(a){console['warn'](a0g(0x76),a);}}catch(t){console[a0g(0x1a)]('initial\x20header\x20parse\x20error',t);D['close'](0x3f3,a0g(0x77));return;}}try{if(D[a0g(0x78)]===0x1){D['send'](a0g(0x79));}}catch(E){console[a0g(0x27)]('send\x20ack\x20failed',E);}}catch(o){console['error'](a0g(0x7a),o);try{D['close'](0x3f3,a0g(0x7b));}catch(U){}}});D['addEventListener']('close',async()=>{clearInterval(z);try{await K();}catch(H){console[a0g(0x27)]('flush\x20on\x20close\x20failed',H);}});const I=new Headers();c(I);const s={'status':0x65,'webSocket':f,'headers':I};return new Response(null,s);});b[a0g(0xf)](a0g(0x7c),async W=>{return W['text'](a0g(0x7d));});}var src_default={'fetch':async(b,c,J)=>{await initializeApp();return appInstance[a0g(0x7e)](b,c,J);}};export{src_default as default,expiryToISO};